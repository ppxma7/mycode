#!/bin/bash
#SBATCH --partition=defq
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=8
#SBATCH --mem=8g
#SBATCH --time=168:00:00

echo "Running on `hostname`"

module load extension/imaging/
module load brc-pipelines-img/1.7.2

export DATA_DIR="/spmstore/project/NEXPO/NEXPO/inputs/"
export OUTPUT_DIR="/spmstore/project/NEXPO/NEXPO/outputs/"

# subjects=("1688-002C" "15234-003B" "16469-002A" "16498-002A" \
# "16500-002B" "16501-002b" "16521-001b" "16523_002b" \
# "16602-002B" "16707-002A" "16708-03A" "16797-002C" \
# "16798-002A" "16821-002A" "16835-002A" "16885-002A" \
# "16994-002A" "16999-002B" "17057-002C" "17058-002A" "17059-002a")

subjects=("03143_174" "05017_014" "05017_015" "06398_005" "09376_062" "09849_006" \
    "10469_101" "10760_130" "12162_005" "12181_004" "12185_004" "12219_006" \
    "12294_004" "12305_004" "12411_004" "12422_004" "12428_005" "12487_003" \
    "12578_004" "12608_004" "12838_004" "12869_013" "12869_016" "12929_004" \
    "12967_004" "12969_004" "13006_004" "13673_015" "13676_074" "14007_003" \
    "14342_003" "15721_009" "15951_002" "15955_002" "15999_003" "16014_002" \
    "16043_002" "16044_002" "16046_002" "16058_002" "16101_002" "16102_002" \
    "16103_002" "16121_002" "16122_002" "16133_002" "16154_002" "16174_002" \
    "16175_002" "16176_002" "16231_003" "16277_002" "16278_002" "16279_002" \
    "16280_002" "16281_002" "16282_002" "16283_002" "16296_002" "16297_002" \
    "16298_002" "16299_002" "16301_002" "16302_002" "16303_002" "16321_002" \
    "16322_002" "16377_002" "16388_002" "16389_002" "16390_002" "16404_002" \
    "16404_004" "16418_002" "16419_002" "16430_002" "16437_002" "16438_002" \
    "16439_002" "16462_002" "16463_002" "16464_002" "16465_002" "16466_002" \
    "16467_002" "16494_002" "16511_002" "16512_002" "16513_002" "16514_002" \
    "16517_002" "16528_002" "16542_002" "16543_002" "16544_002" "16568_002" \
    "16569_002" "16570_002" "16613_002" "16615_002" "16618_002" "16621_002" \
    "16623_002" "16627_002" "16661_002" "16662_002" "16663_002" "16664_002" \
    "16693_002" "16699_002" "16701_002" "16702_002" "16725_002" "16726_002" \
    "16728_005" "16775_002" "16787_002" "16788_002" "16789_002" "16791_002" \
    "16793_006" "16824_002" "16866_002" "16871_002" "16874_002" "16878_002" \
    "16910_002" "16911_002" "16985_002" "16986_002" "16987_002" "17007_002" \
    "17038_002" "17040_002" "17041_002" "17072_002" "17073_002" "17074_002" \
    "17075_002" "17076_002" "17080_002" "17083_002" "17084_002" "17086_002" \
    "17102_002" "17103_002" "17104_002" "17105_002" "17108_002" "17111_002" \
    "17127_002" "17128_002" "17129_002" "17171_002" "17173_002" "17176_002" \
    "17178_002" "17180_002" "17207_002" "17208_002" "17210_002" "17221_002" \
    "17239_002" "17243_002" "17275_002" "17292_002" "17293_002" "17305_002" \
    "17324_002" "17341_002" "17342_002" "17348_002" "17364_002" "17394_002" \
    "17395_002" "17449_002" "17453_002" "17456_002" "17491_002" "17492_002" \
    "17532_002" "17577_002" "17580_002" "17581_002" "17589_002" "17594_002" \
    "17596_002" "17606_002" "17607_002" "17610_002" "17617_002" "17698_002" \
    "17704_002" "17706_002" "17723_002" "17765_002" "17769_002" "17930_002" \
    "18031_002" "18038_002" "18076_002" "18089_002" "18094_002")

for subject in "${subjects[@]}"; do
    echo "==========================================="
    echo "Processing subject: ${subject}"

    # Find files
    #DTI_FILE=$(find "${DATA_DIR}/${subject}/DTI/" -type f -iname "*sDTI_b1k_30b2k*.nii*" | head -n 1)
    #BLIP_FILE=$(find "${DATA_DIR}/${subject}/DTI/" -type f -iname "*blipMB3*sDTI*.nii*" ! -iname "*_ph.nii" | head -n 1)

    DTI_FILE=$(find "${DATA_DIR}/${subject}/DTI/" -type f -iname "*WIP_DTI_Biobank*.nii*" | head -n 1)
    BLIP_FILE=$(find "${DATA_DIR}/${subject}/DTI/" -type f -iname "*blip_DTI*.nii*" ! -iname "*_ph.nii" | head -n 1)

    # Validate presence of files
    if [[ -z "$DTI_FILE" ]]; then
        echo "❌ ERROR: No DTI file found for ${subject}, skipping."
        continue
    fi
    if [[ -z "$BLIP_FILE" ]]; then
        echo "⚠️ WARNING: No BLIP file found for ${subject}, using NONE."
        BLIP_FILE="NONE"
    fi

    # Skip if either file missing
    if [[ -z "$DTI_FILE" || -z "$BLIP_FILE" ]]; then
        echo "❌ ERROR: Missing required files for ${subject}, skipping."
        echo "  DTI_FILE : ${DTI_FILE:-NOT FOUND}"
        echo "  BLIP_FILE: ${BLIP_FILE:-NOT FOUND}"
        continue
    fi
    echo "  DTI_FILE : ${DTI_FILE}"
    echo "  BLIP_FILE: ${BLIP_FILE}"

    # Run pipeline
    dMRI_preproc.sh \
        --input "${DTI_FILE}" \
        --input_2 "${BLIP_FILE}" \
        --path "${OUTPUT_DIR}" \
        --subject "${subject}" \
        --echospacing 0.000668561 \
        --pe_dir 2
done

echo "All done."


